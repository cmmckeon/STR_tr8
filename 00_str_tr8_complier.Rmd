---
title: "00_str_tr8_complier"
author: "Caroline McKeon"
date: "03/17/2020"
output: word_document
---

This markdown is for the extraction, wrangling and analysis of data relating to species range metrics and functional traits.

# Notes: 
- Anna Csergo is already looking at the relationship between spatial scales in these metrics across species. 
- How rare and how recorded a species is will also matter.
- which traits to use?
- species mean or location specific traits?
- Measures of intraspecific trait variability?
- could re-extract and clean up massively (amalgamate trait data), might improve sample size

# Set up
```{r setup, include=FALSE}
#install.packages(c("tidyverse", "glmmTMB"))
#install.packages("RPostgreSQL", type="source")
#install.packages("BIEN")
source("00_str_functions.R")
knitr::opts_chunk$set(include=FALSE) 
knitr::opts_chunk$set(fig.width=16, fig.height=10) 
```

## get traits
Get TRY and BIEN trait data
```{r}
source("01_get_trait_data.R")
```
## clean traits
Clean and collate trait data
```{r}
source("02_clean_trait_data.R")
```
## get range metrics
Read in species range metrics.
```{r}
metrics <- read.csv("Data_range_metrics.csv") ## for now this is the updated metrics as calculated by Anna Csergo in spring 2019
metrics <- metrics[metrics$Species %in% sp.list_full_TRY_BIEN & metrics$Model == "Occurrence",]
metrics <- unique(metrics[, which(names(metrics) %in% 
                                    c("Species", "effective.mesh.size", "mean.shape.index", "prop.landscape", 
                                      "total.area", "perimeter.area.frac.dim", "range.size"))])
names(metrics) <- c("species", "effective.mesh.size", "mean.shape.index", "prop.landscape", 
                                      "total.area", "perimeter.area.frac.dim", "range.size")

```

## get trait sumamry statistics
Calculate summary stats for continuous traits
```{r}
cont <- c("height", "leaf_area", "seed_mass", "sla")
## get the single values for each species
for(j in cont){
  a <- x[[j]]
  a[,2] <- as.numeric(a[,2])
  
  for(i in levels(a$species)){
  a$mean[a$species == i] <- gm_mean(a[,2][a$species == i])
  a$median[a$species == i] <- median(a[,2][a$species == i])
  a$max[a$species == i] <- max(a[,2][a$species == i])
  a$coeff_var[a$species == i] <- (sd(a[,2][a$species == i])/mean(a[,2][a$species == i]))*100
  }
  
  x[[j]] <- unique(a[,-2])
}

rm(a)

## Extract each dataset
height <- x[["height"]] ## 195 species
leaf_area <- x[["leaf_area"]] ## 41 speceis
lifeform <- x[["lifeform"]] ## 165 species
seed_mass <- x[["seed_mass"]] ## 96 species
sla <- x[["sla"]] ## 86 species
woodiness <- x[["woodiness"]] ## 238 species
```


Look at overlap in species between trait datasets
```{r}
# for maybe if you wanted this list all together in a data frame
b <- data.frame(unique(mydata$species))
names(b) <- "species"
# for (i in levels(mydata$trait_name)){
#   b <- unique(merge(b, mydata[,which(names(mydata) %in% c('species', i))], by = "species"))
# }

b <- droplevels(unique(merge(woodiness, lifeform, by = "species"))) ## 140
b <- droplevels(unique(merge(b, height, by = "species"))) ## 137
b <- droplevels(unique(merge(b, seed_mass, by = "species"))) ## 80
b <- droplevels(unique(merge(b, sla, by = "species"))) ## 30
b <- droplevels(unique(merge(b, leaf_area, by = "species"))) ## 30
b <- drop_na(b)
rm(b)
```


Plot summary stats
```{r}
stat <- c("mean","median", "max", "coeff_var")
par(mfrow = c(4,4))
  for(j in stat){
for(i in cont){

    hist(log(x[[i]][,j]), main = paste(i,j), xlab = paste("log",j), cex = 1, breaks = 50)
}}
```


```{r}
par(mfrow = c(1,2))
plot(factor(lifeform$lifeform))
plot(factor(woodiness$woodiness))
```

Merge trait and metric dataframes
```{r}
b <- data.frame(unique(mydata$species))
names(b) <- "species"
for (i in cont){
  b <- merge(b, x[[i]][,which(names(x[[i]]) %in% c('species', "max"))], by = "species", all.x = T); 
  names(b)[names(b) == 'max'] <- paste(i, "max", sep = "_") 
}
for (i in c("lifeform", "woodiness")){
  b <- merge(b, x[[i]], by = "species", all.x = T)
}

mydata <- unique(merge(metrics, b, by = "species"))
mydata$woodiness <- factor(mydata$woodiness)
mydata$lifeform <- factor(mydata$lifeform)
# ## get ModelDF species names in the right format to match with those in phylogenetic trees
levels(mydata$species) <- gsub(" ", "_", levels(mydata$species))
rm(b)
```


```{r}
## Quick look at model dataframe
## Factors
for (i in names(Filter(is.factor, mydata))) {
  plot(mydata[,i],
       main = paste(i))
}

## Numeric variables
for (i in names(Filter(is.numeric, mydata))) {
  hist(log(mydata[,i]),
       breaks = 3000,
       main = paste(i),
       xlab = paste(i))
}
```
## get phylogeny
Set up phlyogeny
```{r}
if(!exists("clean_tree")) {
  try(clean_tree <- read.tree("Data_str_clean_tree.tre"))
  } else source("03_clean_phylogeny.R")
```

Set up individual datasets for analysis
```{r}
## Extract each dataset
height <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "height_max"))]))
leaf_area <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "leaf_area_max"))]))
lifeform <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "lifeform"))]))
seed_mass <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "seed_mass_max"))]))
sla <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "sla_max"))]))
woodiness <- unique(drop_na(mydata[, which(names(mydata) %in% c("species", "effective.mesh.size", "mean.shape.index", 
                                                      "prop.landscape", "total.area", "perimeter.area.frac.dim", 
                                                      "range.size", "woodiness"))]))
```

scale data
```{r}
# for (i in names(Filter(is.numeric, height))) {
#   height[, i] <- c(scale(height[,i]))
# }
# for (i in names(Filter(is.numeric, leaf_area))) {
#   leaf_area[, i] <- c(scale(leaf_area[,i]))
# }
# for (i in names(Filter(is.numeric, seed_mass))) {
#   seed_mass[, i] <- c(scale(seed_mass[,i]))
# }
# for (i in names(Filter(is.numeric, sla))) {
#   sla[, i] <- c(scale(sla[,i]))
# }
# for (i in names(Filter(is.numeric, lifeform))) {
#   lifeform[, i] <- c(scale(lifeform[,i]))
# }
# for (i in names(Filter(is.numeric, woodiness))) {
#   woodiness[, i] <- c(scale(woodiness[,i]))
# }
```

## look at colinearity
```{r}
source("04_exploration_and_colinearity.R")
```



## Analysis
## 1. Metric ~ trait

```{r}
source("05a_str_bayesian_bivariate_analysis.R")
```





